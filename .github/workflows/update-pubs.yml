name: Actualización Semanal de Publicaciones

# --- Disparadores (Triggers) ---
on:
  # 1. Se ejecuta automáticamente cada lunes a las 5:00 AM UTC
  schedule:
    - cron: '0 5 * * 1'
  
  # 2. Permite la ejecución manual desde la pestaña "Actions" de GitHub
  workflow_dispatch:

jobs:
  update-and-publish:
    runs-on: ubuntu-latest
    
    # Permisos necesarios para hacer commit y publicar en gh-pages
    permissions:
      contents: write  # Para hacer commit de los .bib
      pages: write     # Para publicar en gh-pages
      id-token: write  # Para autenticación de gh-pages

    steps:
      # --- PASO 0: Configuración Inicial ---

      # Clona el repositorio
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          # Necesario para que quarto-actions pueda hacer commit
          fetch-depth: 0

      # Configura R
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'latest'
          # Usa el gestor de paquetes de RStudio para instalaciones más rápidas
          use-public-rspm: true
        # Añadimos un ID a este paso para poder referenciarlo
        id: setup-r

      # Configura Quarto
      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
      
      # Instala librerías del sistema Ubuntu
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      # Configura el caché de R para que las dependencias se instalen rápido
      - name: Cache R packages
        uses: actions/cache@v4
        with:
          # Usa la ruta de caché correcta generada por el paso 'setup-r'
          path: ~/.local/share/renv
          key: ${{ runner.os }}-renv-${{ hashFiles('renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-renv-

      # --- PASO 1: Instalar Dependencias de R ---

      # Instala las dependencias de R usando tu archivo renv.lock
      - name: Install R dependencies (from renv)
        run: |
          Rscript -e "if (!require('renv')) install.packages('renv')"
          Rscript -e "renv::restore()"
        shell: bash

      # PASO NUEVO: Aseguramos que los paquetes clave estén instalados
      - name: Install R dependencies (Safeguard)
        run: |
          Rscript -e "if (!require('rorcid', quietly = TRUE)) install.packages('rorcid')"
          Rscript -e "if (!require('jsonlite', quietly = TRUE)) install.packages('jsonlite')"
          Rscript -e "if (!require('dplyr', quietly = TRUE)) install.packages('dplyr')"
        shell: bash

      # --- PASO 2: Ejecutar Script de R y Comprobar Salida ---
      
      # Ejecuta el script de R y captura su salida de texto para
      # que podamos comprobar si se encontraron nuevas publicaciones.
      - name: Run R Script and Check for new citations
        id: check_script
        # ¡IMPORTANTE! Pasa el Token de ORCID como una variable de entorno
        # El paquete 'rorcid' sabe cómo usar esta variable automáticamente.
        env:
          ORCID_TOKEN: ${{ secrets.ORCID_TOKEN }}
        run: |
          # Simplemente ejecutamos tu script de R
          R_SCRIPT_COMMAND="
            print('--- Ejecutando script retrieve_references.R... ---');
            source('references/retrieve_references.R');
          "
          
          # Ejecuta el comando de R y guarda su salida
          OUTPUT=$(Rscript -e "$R_SCRIPT_COMMAND" 2>&1)
          
          # Imprime la salida del R script al log (para depuración)
          echo "--- R Script Output ---"
          echo "$OUTPUT"
          echo "-----------------------"
          
          # Comprueba si la salida contiene la frase "Added new citations"
          if echo "$OUTPUT" | grep -q "Added new citations"; then
            echo "¡Nuevas publicaciones encontradas! Preparando para publicar..."
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "No hay publicaciones nuevas. No se requiere ninguna acción."
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # --- PASO 3: Hacer Commit de los Cambios (si los hay) ---
      
      # Este paso solo se ejecuta si el paso anterior (id: check_script)
      # detectó cambios (outputs.changes_detected == 'true')
      - name: Commit publication files
        if: steps.check_script.outputs.changes_detected == 'true'
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add references/pubs.bib references/conferences.bib references/books.bib references/orcid_works_check.csv
          
          # Solo hace commit si hay algo que "comitear"
          # El "|| true" evita que el workflow falle si no hay cambios (aunque no debería llegar aquí)
          git commit -m "Actualización automática de publicaciones desde ORCID" || true
          git push || true # Empuja los cambios, ignora si no hay nada que empujar

      # --- PASO 4: Publicar en GitHub Pages (si hubo cambios) ---
      
      # Este paso también depende de la variable 'changes_detected'
      - name: Publish to GitHub Pages
        if: steps.check_script.outputs.changes_detected == 'true'
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

